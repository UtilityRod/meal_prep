<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/app/css/styles.css">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body>
  <header style="margin-bottom:10px;">
    <img id="site-logo" src="/app/assets/MealPlannerAdmin.png" alt="Meal Planner Admin">
  </header>
  <p class="small">Simple UI wired to your <code>/v1</code> Gin API.</p>
  <div id="global-message" class="small"></div>

  <div class="layout">
    <!-- MEAL PLANS PANEL -->
    <div class="panel" id="panel-mealplans">
      <h2><img src="/app/assets/MealPlans.png" alt="Meal Plans"></h2>

      <div class="panel-section">
        <button type="button" id="reload-mealplans-btn">Reload Meal Plans</button>
        <div id="mealplans-error" class="error"></div>
        <table id="mealplans-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Start</th>
              <th>End</th>
              <th>View</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody>
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>

      <div class="panel-section">
        <h3>Create</h3>
        <form id="create-mealplan-form">
          <label for="mealplan-name">Name</label>
          <input id="mealplan-name" name="name" required>

          <label for="mealplan-start">Start Date</label>
          <input id="mealplan-start" name="start_date" type="date" required>

          <label for="mealplan-end">End Date</label>
          <input id="mealplan-end" name="end_date" type="date" required>

          <button type="submit">Create Meal Plan</button>
        </form>
        <div id="create-mealplan-message" class="small"></div>
      </div>

      <div class="panel-section">
        <h3>Details &amp; Planned Recipes</h3>
        <div id="mealplan-details">
          <p class="small text-muted">Select "View" on a meal plan.</p>
        </div>
      </div>
    </div>

    <!-- RECIPES PANEL -->
    <div class="panel" id="panel-recipes">
      <h2 class="title-row">
        <img src="/app/assets/Recipes.png" alt="Recipes">
        <a href="/meal_search.html" title="Meal Search">
          <img src="/app/assets/meal_icon.svg" alt="Meal Search" class="meal-icon">
        </a>
      </h2>

      <div class="panel-section">
        <button type="button" id="reload-recipes-btn">Reload Recipes</button>
        <div id="recipes-error" class="error"></div>
        <table id="recipes-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Serv.</th>
              <th>Times</th>
              <th>View</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody>
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>

      <div class="panel-section">
        <h3>Create</h3>
        <form id="create-recipe-form">
          <label for="recipe-title">Title</label>
          <input id="recipe-title" name="title" required>

          <label for="recipe-description">Description</label>
          <textarea id="recipe-description" name="description"></textarea>

          <label for="recipe-servings">Servings (integer)</label>
          <input id="recipe-servings" name="servings" type="number" min="1">

          <label for="recipe-prep-time">Prep Time (minutes)</label>
          <input id="recipe-prep-time" name="prep_time" type="number" min="0">

          <label for="recipe-cook-time">Cook Time (minutes)</label>
          <input id="recipe-cook-time" name="cook_time" type="number" min="0">

          <label for="recipe-youtube">YouTube Link (optional)</label>
          <input id="recipe-youtube" name="youtube_link" placeholder="https://www.youtube.com/watch?v=...">

          <div style="display:flex; gap:8px; align-items:center; margin-top:12px; margin-bottom:14px;">
            <button id="open-instructions-btn" type="button">Instructions</button>
            <div class="small text-muted">Open editor to add rich instructions</div>
          </div>

          <input type="hidden" id="recipe-instructions" name="instructions">

          <button type="submit">Create Recipe</button>
        </form>
        <div id="create-recipe-message" class="small"></div>
      </div>

      <div class="panel-section">
        <h3>Details</h3>
        <div id="recipe-details">
          <p class="small text-muted">Select "View" on a recipe.</p>
        </div>
      </div>
    </div>

    <!-- INGREDIENTS PANEL -->
    <div class="panel" id="panel-ingredients">
      <h2><img src="/app/assets/Ingredients.png" alt="Ingredients"></h2>
      <div id="ingredients-panel">
        <p class="small text-muted">Select a recipe to view and manage its ingredients.</p>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/v1';
    let selectedRecipeId = null;

    function setGlobalMessage(message, isError) {
      const el = document.getElementById('global-message');
      el.textContent = message || '';
      el.className = isError ? 'error' : 'success';
    }

    async function apiRequest(path, options = {}) {
      try {
        const res = await fetch(API_BASE + path, {
          headers: { 'Content-Type': 'application/json' },
          ...options
        });

        if (!res.ok) {
          let text = '';
          try { text = await res.text(); } catch (e) {}
          throw new Error(`HTTP ${res.status}: ${text || res.statusText}`);
        }

        try { return await res.json(); } catch (_) { return null; }
      } catch (err) {
        throw err;
      }
    }

    /* ------------ RECIPES ------------ */

    async function loadRecipes() {
      const tbody = document.querySelector('#recipes-table tbody');
      const errorEl = document.getElementById('recipes-error');
      tbody.innerHTML = '';
      errorEl.textContent = '';

      try {
        const data = await apiRequest('/recipes', { method: 'GET' });
        if (!Array.isArray(data)) {
          errorEl.textContent = 'Unexpected response for recipes.';
          return;
        }

        data.forEach(r => {
          const tr = document.createElement('tr');
          const prep = r.prep_time || 0;
          const cook = r.cook_time || 0;

          tr.innerHTML = `
            <td>${r.id ?? ''}</td>
            <td>${r.title ?? ''}</td>
            <td>${r.servings ?? ''}</td>
            <td>Prep: ${prep}, Cook: ${cook}</td>
            <td><button type="button" class="view-recipe-btn" data-recipe-id="${r.id}">View</button></td>
            <td><button type="button" class="delete-recipe-btn" data-recipe-id="${r.id}">Delete</button></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        errorEl.textContent = err.message;
      }
    }

    async function createRecipe(event) {
      event.preventDefault();
      const msgEl = document.getElementById('create-recipe-message');
      msgEl.textContent = '';
      const title = document.getElementById('recipe-title').value.trim();
      const description = document.getElementById('recipe-description').value.trim();
      const servingsVal = document.getElementById('recipe-servings').value;
      const prepVal = document.getElementById('recipe-prep-time').value;
      const cookVal = document.getElementById('recipe-cook-time').value;
      const youtube = document.getElementById('recipe-youtube').value.trim();
      const instructions = document.getElementById('recipe-instructions').value || null;

      // validate youtube if present
      if (youtube && !(function(u){ try{ const url=new URL(u); const h=url.hostname.toLowerCase(); return h.includes('youtube.com')||h.includes('youtu.be'); }catch(e){return false} })(youtube)) {
        msgEl.textContent = 'Please enter a valid YouTube link or leave blank.';
        msgEl.className = 'error';
        return;
      }

      const payload = {
        title: title,
        description: description || null,
        servings: servingsVal ? parseInt(servingsVal, 10) : null,
        prep_time: prepVal ? parseInt(prepVal, 10) : null,
        cook_time: cookVal ? parseInt(cookVal, 10) : null,
        instructions: instructions,
        youtube_link: youtube || null
      };

      try {
        await apiRequest('/recipes', { method: 'POST', body: JSON.stringify(payload) });
        msgEl.textContent = 'Recipe created.'; msgEl.className = 'success';
        event.target.reset();
        document.getElementById('recipe-instructions').value = '';
        loadRecipes();
      } catch (err) {
        msgEl.textContent = err.message;
        msgEl.className = 'error';
      }
    }

    async function viewRecipeDetails(recipeId) {
      const detailsEl = document.getElementById('recipe-details');
      detailsEl.innerHTML = '<p class="small text-muted">Loading recipe...</p>';

      try {
        const recipe = await apiRequest(`/recipes/${recipeId}`, { method: 'GET' });

        detailsEl.innerHTML = `
          <h4>Recipe #${recipe.id ?? ''}</h4>
          <p><strong>Title:</strong> ${recipe.title ?? ''}</p>
          <p><strong>Description:</strong><br>${recipe.description ?? ''}</p>
          <p class="small">
            Servings: ${recipe.servings ?? ''} |
            Prep: ${recipe.prep_time ?? 0} min |
            Cook: ${recipe.cook_time ?? 0} min
          </p>

          <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
            ${recipe.instructions ? `<button id="view-instructions-btn" type="button" style="font-size:0.9em;padding:6px 8px;">View Instructions</button>` : ''}
            ${recipe.youtube_link ? `<a id="youtube-link" href="${recipe.youtube_link}" target="_blank" rel="noopener" title="Open YouTube" style="display:inline-flex; align-items:center; gap:6px; text-decoration:none; color:inherit;">
              <svg width="20" height="14" viewBox="0 0 24 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <rect width="24" height="16" rx="4" fill="#FF0000"></rect>
                <path d="M9 4L16 8L9 12V4Z" fill="white"></path>
              </svg>
            </a>` : ''}
          </div>
        `;

        // attach view-instructions handler if present
        const viewBtn = document.getElementById('view-instructions-btn');
        if (viewBtn) {
          viewBtn.addEventListener('click', () => {
            const modal = document.getElementById('view-instructions-modal');
            const content = document.getElementById('view-instructions-content');
            content.innerHTML = recipe.instructions || '<p class="small text-muted">No instructions available.</p>';
            modal.style.display = 'flex';
          });
        }

        selectedRecipeId = recipeId;
        loadIngredientsForRecipe(recipeId);
      } catch (err) {
        detailsEl.innerHTML = `<p class="error">${err.message}</p>`;
      }
    }

    async function deleteRecipe(recipeId) {
      if (!confirm('Delete this recipe? This will also delete its ingredients.')) return;
      try {
        await apiRequest(`/recipes/${recipeId}`, { method: 'DELETE' });
        setGlobalMessage('Recipe deleted.', false);
        loadRecipes();
        if (selectedRecipeId === recipeId) {
          document.getElementById('recipe-details').innerHTML =
            '<p class="small text-muted">Select "View" on a recipe.</p>';
          document.getElementById('ingredients-panel').innerHTML =
            '<p class="small text-muted">Select a recipe to view and manage its ingredients.</p>';
          selectedRecipeId = null;
        }
      } catch (err) {
        setGlobalMessage(err.message, true);
      }
    }

    /* ------------ INGREDIENTS (per selected recipe) ------------ */

    async function loadIngredientsForRecipe(recipeId) {
      const panel = document.getElementById('ingredients-panel');
      panel.innerHTML = '<p class="small text-muted">Loading ingredients...</p>';

      try {
        const list = await apiRequest(`/recipes/${recipeId}/ingredients`, { method: 'GET' }) || [];
        const rows = (Array.isArray(list) ? list : []).map(i => `
          <tr>
            <td>${i.id ?? ''}</td>
            <td>${i.name ?? ''}</td>
            <td>${i.quantity ?? ''}</td>
            <td>${i.unit ?? ''}</td>
            <td>
              <button type="button" class="edit-ingredient-btn"
                      data-ingredient-id="${i.id}" data-recipe-id="${recipeId}">
                Edit
              </button>
            </td>
            <td>
              <button type="button" class="delete-ingredient-btn"
                      data-ingredient-id="${i.id}" data-recipe-id="${recipeId}">
                Del
              </button>
            </td>
          </tr>
        `).join('');

        panel.innerHTML = `
          <p class="small">Ingredients for recipe ID <strong>${recipeId}</strong></p>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Edit</th>
                <th>Del</th>
              </tr>
            </thead>
            <tbody>
              ${rows || '<tr><td colspan="6" class="small text-muted">No ingredients yet.</td></tr>'}
            </tbody>
          </table>

          <div class="panel-section">
            <h4>Add Ingredient</h4>
            <form id="add-ingredient-form" data-recipe-id="${recipeId}">
              <label for="ingredient-name">Name</label>
              <input id="ingredient-name" name="name" required>

              <label for="ingredient-quantity">Quantity (text)</label>
              <input id="ingredient-quantity" name="quantity">

              <label for="ingredient-unit">Unit</label>
              <input id="ingredient-unit" name="unit">

              <button type="submit">Add</button>
            </form>
            <div id="add-ingredient-message" class="small"></div>
          </div>

          <div class="panel-section">
            <h4>Edit Ingredient</h4>
            <p id="edit-ingredient-hint" class="small text-muted">
              Select "Edit" on an ingredient above.
            </p>
            <form id="edit-ingredient-form" data-ingredient-id="" data-recipe-id="${recipeId}" style="display:none;">
              <label for="edit-ingredient-name">Name</label>
              <input id="edit-ingredient-name" name="name" required>

              <label for="edit-ingredient-quantity">Quantity (text)</label>
              <input id="edit-ingredient-quantity" name="quantity">

              <label for="edit-ingredient-unit">Unit</label>
              <input id="edit-ingredient-unit" name="unit">

              <button type="submit">Save Changes</button>
            </form>
            <div id="edit-ingredient-message" class="small"></div>
          </div>
        `;
      } catch (err) {
        panel.innerHTML = `<p class="error">${err.message}</p>`;
      }
    }

    async function addIngredient(event) {
      event.preventDefault();
      const form = event.target;
      const recipeId = form.getAttribute('data-recipe-id');
      const msgEl = document.getElementById('add-ingredient-message');
      msgEl.textContent = '';

      const name = document.getElementById('ingredient-name').value.trim();
      const quantity = document.getElementById('ingredient-quantity').value.trim();
      const unit = document.getElementById('ingredient-unit').value.trim();

      const payload = {
        name: name,
        quantity: quantity || null,
        unit: unit || null
      };

      try {
        await apiRequest(`/recipes/${recipeId}/ingredients`, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        msgEl.textContent = 'Ingredient added.';
        msgEl.className = 'success';
        form.reset();
        loadIngredientsForRecipe(recipeId);
      } catch (err) {
        msgEl.textContent = err.message;
        msgEl.className = 'error';
      }
    }

    async function loadIngredientForEdit(ingredientId, recipeId) {
      const hintEl = document.getElementById('edit-ingredient-hint');
      const form = document.getElementById('edit-ingredient-form');
      const msgEl = document.getElementById('edit-ingredient-message');

      if (!form) return;

      hintEl.textContent = 'Loading ingredient...';
      msgEl.textContent = '';

      try {
        const ing = await apiRequest(`/ingredients/${ingredientId}`, { method: 'GET' });

        document.getElementById('edit-ingredient-name').value = ing.name ?? '';
        document.getElementById('edit-ingredient-quantity').value = ing.quantity ?? '';
        document.getElementById('edit-ingredient-unit').value = ing.unit ?? '';

        form.style.display = 'block';
        form.setAttribute('data-ingredient-id', ingredientId);
        form.setAttribute('data-recipe-id', recipeId);
        hintEl.textContent = `Editing ingredient #${ingredientId}`;
      } catch (err) {
        hintEl.textContent = 'Error loading ingredient for edit.';
        msgEl.textContent = err.message;
        msgEl.className = 'error';
      }
    }

    async function updateIngredient(event) {
      event.preventDefault();
      const form = event.target;
      const ingredientId = form.getAttribute('data-ingredient-id');
      const recipeId = form.getAttribute('data-recipe-id');
      const msgEl = document.getElementById('edit-ingredient-message');
      msgEl.textContent = '';

      if (!ingredientId) {
        msgEl.textContent = 'No ingredient selected.';
        msgEl.className = 'error';
        return;
      }

      const name = document.getElementById('edit-ingredient-name').value.trim();
      const quantity = document.getElementById('edit-ingredient-quantity').value.trim();
      const unit = document.getElementById('edit-ingredient-unit').value.trim();

      const payload = {
        name: name,
        quantity: quantity || null,
        unit: unit || null
      };

      try {
        await apiRequest(`/ingredients/${ingredientId}`, {
          method: 'PUT',
          body: JSON.stringify(payload)
        });
        msgEl.textContent = 'Ingredient updated.';
        msgEl.className = 'success';
        loadIngredientsForRecipe(recipeId);
      } catch (err) {
        msgEl.textContent = err.message;
        msgEl.className = 'error';
      }
    }

    async function deleteIngredient(ingredientId, recipeId) {
      if (!confirm('Delete this ingredient?')) return;
      try {
        await apiRequest(`/ingredients/${ingredientId}`, { method: 'DELETE' });
        loadIngredientsForRecipe(recipeId);
      } catch (err) {
        setGlobalMessage(err.message, true);
      }
    }

    /* ------------ MEAL PLANS ------------ */

    async function loadMealPlans() {
      const tbody = document.querySelector('#mealplans-table tbody');
      const errorEl = document.getElementById('mealplans-error');
      tbody.innerHTML = '';
      errorEl.textContent = '';

      try {
        const data = await apiRequest('/meal-plans', { method: 'GET' });
        if (!Array.isArray(data)) {
          errorEl.textContent = 'Unexpected response for meal plans.';
          return;
        }

        data.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${p.id ?? ''}</td>
            <td>${p.name ?? ''}</td>
            <td>${p.start_date ?? ''}</td>
            <td>${p.end_date ?? ''}</td>
            <td><button type="button" class="view-mealplan-btn" data-plan-id="${p.id}">View</button></td>
            <td><button type="button" class="delete-mealplan-btn" data-plan-id="${p.id}">Delete</button></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        errorEl.textContent = err.message;
      }
    }

    async function createMealPlan(event) {
      event.preventDefault();
      const msgEl = document.getElementById('create-mealplan-message');
      msgEl.textContent = '';

      const name = document.getElementById('mealplan-name').value.trim();
      const start = document.getElementById('mealplan-start').value.trim();
      const end = document.getElementById('mealplan-end').value.trim();

      const payload = {
        name: name,
        start_date: start,
        end_date: end
      };

      try {
        await apiRequest('/meal-plans', {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        msgEl.textContent = 'Meal plan created.';
        msgEl.className = 'success';
        event.target.reset();
        loadMealPlans();
      } catch (err) {
        msgEl.textContent = err.message;
        msgEl.className = 'error';
      }
    }

    async function populateRecipeDropdown(selectEl) {
      try {
        const recipes = await apiRequest('/recipes', { method: 'GET' });

        if (!Array.isArray(recipes)) {
          selectEl.innerHTML = '<option value="">(error loading recipes)</option>';
          return;
        }

        if (recipes.length === 0) {
          selectEl.innerHTML = '<option value="">(no recipes yet)</option>';
          return;
        }

        selectEl.innerHTML = recipes
          .map(r => `<option value="${r.id}">${r.id} â€“ ${r.title}</option>`)
          .join('');
      } catch (err) {
        selectEl.innerHTML = '<option value="">Error loading recipes</option>';
      }
    }

    async function viewMealPlanDetails(planId) {
      const container = document.getElementById('mealplan-details');
      container.innerHTML = '<p class="small text-muted">Loading...</p>';

      try {
        const plan = await apiRequest(`/meal-plans/${planId}`, { method: 'GET' });
        const planRecipes = await apiRequest(`/meal-plans/${planId}/recipes`, { method: 'GET' }) || [];

        const rows = (Array.isArray(planRecipes) ? planRecipes : []).map(pr => `
          <tr>
            <td>${pr.id ?? ''}</td>
            <td>${pr.planned_date ?? ''}</td>
            <td>${pr.meal_type ?? ''}</td>
            <td>${pr.recipe_id ?? ''}</td>
            <td>
              <button type="button" class="view-recipe-from-plan-btn" data-recipe-id="${pr.recipe_id}">
                View
              </button>
            </td>
            <td>
              <button type="button" class="delete-plan-recipe-btn" data-plan-recipe-id="${pr.id}" data-plan-id="${plan.id}">
                Del
              </button>
            </td>
          </tr>
        `).join('');

        container.innerHTML = `
          <h4>Meal Plan #${plan.id ?? ''}</h4>
          <p><strong>Name:</strong> ${plan.name ?? ''}</p>
          <p class="small">From ${plan.start_date ?? ''} to ${plan.end_date ?? ''}</p>

          <h4>Planned Recipes</h4>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Date</th>
                <th>Meal Type</th>
                <th>Recipe ID</th>
                <th>View</th>
                <th>Del</th>
              </tr>
            </thead>
            <tbody>
              ${rows || '<tr><td colspan="6" class="small text-muted">No entries.</td></tr>'}
            </tbody>
          </table>

          <div class="panel-section">
            <h4>Add Recipe to Plan</h4>
            <form id="add-plan-recipe-form" data-plan-id="${planId}">
              <label for="plan-recipe-select">Select Recipe</label>
              <select id="plan-recipe-select" name="recipe_id" required></select>

              <label for="plan-meal-type">Meal Type (e.g. breakfast)</label>
              <input id="plan-meal-type" name="meal_type">

              <label for="plan-date">Planned Date</label>
              <input id="plan-date" name="planned_date" type="date" required>

              <button type="submit">Add</button>
            </form>
            <div id="add-plan-recipe-message" class="small"></div>
          </div>
        `;
        const select = document.getElementById('plan-recipe-select');
        if (select) {
          populateRecipeDropdown(select);
        }
      } catch (err) {
        container.innerHTML = `<p class="error">${err.message}</p>`;
      }
    }

    async function addPlanRecipe(event) {
      event.preventDefault();
      const form = event.target;
      const planId = form.getAttribute('data-plan-id');
      const msgEl = document.getElementById('add-plan-recipe-message');
      msgEl.textContent = '';

      const recipeSelect = document.getElementById('plan-recipe-select');
      if (!recipeSelect) {
        msgEl.textContent = 'Recipe dropdown not found.';
        msgEl.className = 'error';
        return;
      }

      const recipeIdVal = recipeSelect.value;
      const mealType = document.getElementById('plan-meal-type').value.trim();
      const plannedDate = document.getElementById('plan-date').value.trim();

      const payload = {
        recipe_id: recipeIdVal ? parseInt(recipeIdVal, 10) : null,
        meal_type: mealType || null,
        planned_date: plannedDate
      };

      try {
        await apiRequest(`/meal-plans/${planId}/recipes`, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        msgEl.textContent = 'Recipe added to meal plan.';
        msgEl.className = 'success';
        form.reset();
        const select = document.getElementById('plan-recipe-select');
        if (select) populateRecipeDropdown(select);
        viewMealPlanDetails(planId);
      } catch (err) {
        msgEl.textContent = err.message;
        msgEl.className = 'error';
      }
    }

    async function deletePlanRecipe(planRecipeId, planId) {
      if (!confirm('Delete this planned recipe entry?')) return;
      try {
        await apiRequest(`/plan-recipes/${planRecipeId}`, { method: 'DELETE' });
        setGlobalMessage('Planned recipe deleted.', false);
        if (planId) viewMealPlanDetails(planId);
      } catch (err) {
        setGlobalMessage(err.message, true);
      }
    }

    async function deleteMealPlan(planId) {
      if (!confirm('Delete this meal plan and all associated entries?')) return;
      try {
        await apiRequest(`/meal-plans/${planId}`, { method: 'DELETE' });
        setGlobalMessage('Meal plan deleted.', false);
        loadMealPlans();
        const current = document.querySelector('#mealplan-details h4');
        if (current && current.textContent.includes(`#${planId}`)) {
          document.getElementById('mealplan-details').innerHTML =
            '<p class="small text-muted">Select "View" on a meal plan.</p>';
        }
      } catch (err) {
        setGlobalMessage(err.message, true);
      }
    }

    /* ------------ EVENT WIRING ------------ */

    document.addEventListener('DOMContentLoaded', () => {
      loadRecipes();
      loadMealPlans();

      document.getElementById('reload-recipes-btn')
        .addEventListener('click', loadRecipes);
      document.getElementById('reload-mealplans-btn')
        .addEventListener('click', loadMealPlans);

      document.getElementById('create-recipe-form')
        .addEventListener('submit', createRecipe);

      document.getElementById('create-mealplan-form')
        .addEventListener('submit', createMealPlan);

      // Recipe list events
      document.querySelector('#recipes-table tbody')
        .addEventListener('click', (e) => {
          const viewBtn = e.target.closest('.view-recipe-btn');
          if (viewBtn) {
            const id = viewBtn.getAttribute('data-recipe-id');
            if (id) viewRecipeDetails(id);
          }
          const delBtn = e.target.closest('.delete-recipe-btn');
          if (delBtn) {
            const id = delBtn.getAttribute('data-recipe-id');
            if (id) deleteRecipe(id);
          }
        });

      // Ingredients panel events
      document.getElementById('panel-ingredients')
        .addEventListener('submit', (e) => {
          if (e.target && e.target.id === 'add-ingredient-form') {
            addIngredient(e);
          } else if (e.target && e.target.id === 'edit-ingredient-form') {
            updateIngredient(e);
          }
        });

      document.getElementById('panel-ingredients')
        .addEventListener('click', (e) => {
          const editBtn = e.target.closest('.edit-ingredient-btn');
          if (editBtn) {
            const ingId = editBtn.getAttribute('data-ingredient-id');
            const recipeId = editBtn.getAttribute('data-recipe-id');
            if (ingId && recipeId) {
              loadIngredientForEdit(ingId, recipeId);
            }
            return;
          }

          const delBtn = e.target.closest('.delete-ingredient-btn');
          if (delBtn) {
            const ingId = delBtn.getAttribute('data-ingredient-id');
            const recipeId = delBtn.getAttribute('data-recipe-id');
            if (ingId && recipeId) {
              deleteIngredient(ingId, recipeId);
            }
          }
        });

      // Meal plans list events
      document.querySelector('#mealplans-table tbody')
        .addEventListener('click', (e) => {
          const viewBtn = e.target.closest('.view-mealplan-btn');
          if (viewBtn) {
            const id = viewBtn.getAttribute('data-plan-id');
            if (id) viewMealPlanDetails(id);
          }
          const delBtn = e.target.closest('.delete-mealplan-btn');
          if (delBtn) {
            const id = delBtn.getAttribute('data-plan-id');
            if (id) deleteMealPlan(id);
          }
        });

      // Meal plan details events
      document.getElementById('mealplan-details')
        .addEventListener('submit', (e) => {
          if (e.target && e.target.id === 'add-plan-recipe-form') {
            addPlanRecipe(e);
          }
        });

      document.getElementById('mealplan-details')
        .addEventListener('click', (e) => {
          // View recipe from planned recipes
          const viewBtn = e.target.closest('.view-recipe-from-plan-btn');
          if (viewBtn) {
            const recipeId = viewBtn.getAttribute('data-recipe-id');
            if (recipeId) {
              viewRecipeDetails(recipeId);
              const panel = document.getElementById('panel-recipes');
              panel.scrollIntoView({ behavior: 'smooth' });
              panel.classList.add('flash');
              setTimeout(() => panel.classList.remove('flash'), 900);
            }
            return;
          }

          // Delete planned recipe entry
          const btn = e.target.closest('.delete-plan-recipe-btn');
          if (btn) {
            const prId = btn.getAttribute('data-plan-recipe-id');
            const planId = btn.getAttribute('data-plan-id');
            if (prId) deletePlanRecipe(prId, planId);
          }
        });
    });
  </script>
  <!-- Quill modal for instructions -->
  <div id="instructions-modal" style="display:none; position:fixed; left:0; right:0; top:0; bottom:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
    <div style="background:#fff; max-width:800px; width:90%; margin:40px auto; padding:12px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.2);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h3 style="margin:0">Recipe Instructions</h3>
        <div>
          <button id="close-instructions-btn" type="button">Close</button>
        </div>
      </div>
      <div id="quill-editor" style="height:320px; margin-top:8px; background:#fff"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
        <button id="save-instructions-btn" type="button">Save</button>
      </div>
    </div>
  </div>
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script>
    // Quill modal wiring
    const instrModal = document.getElementById('instructions-modal');
    const openInstrBtn = document.getElementById('open-instructions-btn');
    const closeInstrBtn = document.getElementById('close-instructions-btn');
    const saveInstrBtn = document.getElementById('save-instructions-btn');
    const hiddenInstr = document.getElementById('recipe-instructions');
    const quill = new Quill('#quill-editor', { theme: 'snow' });

    openInstrBtn.addEventListener('click', () => {
      instrModal.style.display = 'flex';
      // load existing into quill
      try { quill.root.innerHTML = hiddenInstr.value || ''; } catch(e){}
    });
    closeInstrBtn.addEventListener('click', () => instrModal.style.display = 'none');
    saveInstrBtn.addEventListener('click', () => {
      hiddenInstr.value = quill.root.innerHTML;
      instrModal.style.display = 'none';
    });

    function isYouTubeUrl(u) {
      if (!u) return true; // optional
      try { const url = new URL(u); const h = url.hostname.toLowerCase(); return h.includes('youtube.com') || h.includes('youtu.be'); } catch(e){ return false }
    }
  </script>
  <!-- View-only Instructions modal -->
  <div id="view-instructions-modal" style="display:none; position:fixed; left:0; right:0; top:0; bottom:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
    <div style="background:#fff; max-width:800px; width:90%; margin:40px auto; padding:12px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.2);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h3 style="margin:0">Instructions</h3>
        <div>
          <button id="close-view-instructions-btn" type="button">Close</button>
        </div>
      </div>
      <div id="view-instructions-content" style="height:320px; margin-top:8px; background:#fff; overflow:auto; padding:8px; border:1px solid #eee;"></div>
    </div>
  </div>
  <script>
    // View instructions modal wiring
    (function(){
      const modal = document.getElementById('view-instructions-modal');
      const closeBtn = document.getElementById('close-view-instructions-btn');
      if (!modal) return;
      if (closeBtn) closeBtn.addEventListener('click', () => modal.style.display = 'none');
      // close when clicking backdrop
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
    })();
  </script>
</body>
</html>
